<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Club Tennis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body ng-app="newMember" ng-controller="controller">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.js"></script>
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="/static/style.css">

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Create a new Image object for preloading the hover image
            var hoverImage = new Image();
            hoverImage.src = "/static/tuffy-small-bred.webp";

            // Find the logo-outer element
            var logoOuter = document.querySelector('.logo-outer');
            // Find the logo-inner element
            var logoInner = document.querySelector('.logo-inner');

            // When mouse enters logo-outer, update logo-inner src to the hover image
            logoOuter.addEventListener('mouseenter', function () {
                logoInner.src = hoverImage.src;
            });

            // When mouse leaves logo-outer, revert logo-inner src to the original image
            logoOuter.addEventListener('mouseleave', function () {
                logoInner.src = "/static/tuffy-small-whiteline.webp";
            });
        });
    </script>
    <script>
        var app = angular.module('newMember', []);
        app.controller('controller', function ($scope, $http) {
            $scope.members = [];
            $scope.editMode = false; // Variable to track edit mode

            // Function to load members
            function loadMembers() {
                $http.get("/club/members").then(function (response) {
                    $scope.members = response.data.sort((a, b) => a.Rank - b.Rank);
                });
            }

            // Initial loading of members
            loadMembers();

            // Function to enable edit mode for a member
            $scope.editMember = function (member) {
                // Store the original values for canceling edits
                $scope.originalMember = angular.copy(member);
                $scope.editingMember = member;
                $scope.editMode = true;
            };

            // Function to cancel edit mode and revert changes
            $scope.cancelEdit = function () {
                $scope.editingMember = null;
                $scope.editMode = false;
                // Revert changes to original values
                $scope.members[$scope.members.indexOf($scope.editingMember)] = $scope.originalMember;
            };

            // Function to save edited member
            $scope.saveMember = function () {
                $http.put("/admin/members/" + $scope.editingMember.ID, $scope.editingMember).then(function (response) {
                    loadMembers(); // Reload members after saving
                    $scope.editingMember = null;
                    $scope.editMode = false;
                });
            };

            // Function to remove a member
            $scope.removeMember = function (memberID) {
                $http.delete("/admin/members/" + memberID).then(function (response) {
                    loadMembers(); // Reload members after removing
                });
            };

            // Function to add a new member
            $scope.addMember = function () {
                var newMember = {
                    FirstName: $scope.newFirstName,
                    LastName: $scope.newLastName,
                    UnityID: $scope.newUnityID,
                    Affiliation: $scope.newAffiliation,
                    Email: $scope.newEmail,
                    Ladder: $scope.newLadder,
                    IsOfficer: $scope.newIsOfficer // Adding IsOfficer field
                };

                $http.post("/admin/members", newMember).then(function (response) {
                    loadMembers(); // Reload members after adding
                    // Clear input fields after adding
                    $scope.newFirstName = '';
                    $scope.newLastName = '';
                    $scope.newUnityID = '';
                    $scope.newAffiliation = '';
                    $scope.newEmail = '';
                    $scope.newLadder = '';
                    $scope.newIsOfficer = false; // Resetting the IsOfficer checkbox
                });
            };

            // Function to open delete confirmation modal
            $scope.openDeleteModal = function (member) {
                $scope.deletingMember = member;
                $('#deleteConfirmationModal').modal('show'); // jQuery is used here
            };

            // Function to delete member
            $scope.deleteMember = function (memberID) {
                $http.delete("/admin/members/" + memberID).then(function (response) {
                    loadMembers(); // Reload members after removing
                    $('#deleteConfirmationModal').modal('hide'); // jQuery is used here
                });
            };

            // Function to download users .xlsx file
            $scope.downloadUsers = function () {
                window.location.href = 'backups/users';
            };

            // Function to upload users .xlsx file
            $scope.uploadUsers = function () {
                var formData = new FormData();
                formData.append('users', $scope.usersFile);
                formData.append('replace', $scope.replaceUsers);

                $http.post('backups/users', formData, {
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function (response) {
                    loadMembers(); // Reload members after uploading
                });
            };

            // Function to handle file change event
            $scope.handleFileChange = function (element) {
                $scope.$apply(function () {
                    $scope.usersFile = element.files[0];
                });
            };
        });
    </script>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md">
        <div class="container">
            <!-- Offcanvas toggle button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar header/brand centered -->
            <a class="navbar-brand mx-auto justify-content-between logo-outer" href="/club/">
                <span>NC State</span>
                <img src="/static/tuffy-small-whiteline.webp" class="logo-inner">
                <span>Club Tennis</span>
            </a>
            <!-- Offcanvas navbar content -->
            <div class="offcanvas offcanvas-start offcanvas-red" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h3 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                            aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/club/challenge">Challenge</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/club/announcements">Announcements</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/">Admin Console</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/club/">Club Home</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog"
        aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <strong>{{ deletingMember.FirstName }} {{
                        deletingMember.LastName }}</strong>?
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" ng-click="deleteMember(deletingMember.ID)">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Club Tennis Members</h1>
        <table class="table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Unity ID</th>
                    <th>Affiliation</th>
                    <th>Email</th>
                    <th>Ladder</th>
                    <th>Is Officer</th> <!-- New table header -->
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="member in members">
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.Rank}}</span>
                        <input type="number" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.Rank">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.FirstName}}</span>
                        <input type="text" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.FirstName">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.LastName}}</span>
                        <input type="text" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.LastName">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.UnityID}}</span>
                        <input type="text" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.UnityID">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.Affiliation}}</span>
                        <input type="text" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.Affiliation">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.Email}}</span>
                        <input type="text" class="form-control" ng-show="editMode && editingMember == member"
                            ng-model="member.Email">
                    </td>
                    <td>
                        <span ng-show="!editMode || editingMember != member">{{member.Ladder == 'M' ? 'Mens' : 'Womens'
                            }}</span>
                        <select class="form-select" ng-show="editMode && editingMember == member" ng-model="member.Ladder">
                            <option value="M">Mens</option>
                            <option value="W">Womens</option>
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" class="form-check-input" ng-model="member.IsOfficer"> <!-- Checkbox for IsOfficer -->
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" ng-click="editMember(member)" ng-show="!editMode">Edit</button>
                        <button class="btn btn-success btn-sm" ng-click="saveMember()"
                            ng-show="editMode && editingMember == member">Save</button>
                        <button class="btn btn-danger btn-sm" ng-click="openDeleteModal(member)" ng-show="!editMode">Delete</button>
                        <button class="btn btn-secondary btn-sm" ng-click="cancelEdit()"
                            ng-show="editMode && editingMember == member">Cancel</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- Download/Upload Section -->
        <div class="container mt-5">
            <h2>Backup and Restore Members</h2>
            <div class="row">
                <!-- Download Button -->
                <div class="col-md-6 text-center">
                    <button class="btn btn-success" ng-click="downloadUsers()">Download Members</button>
                </div>
                <!-- Upload Form -->
                <div class="col-md-6">
                    <form ng-submit="uploadUsers()">
                        <div class="mb-3">
                            <label for="usersFile" class="form-label">Upload Members (.xlsx)</label>
                            <input type="file" class="form-control" id="usersFile" accept=".xlsx"
                                onchange="angular.element(this).scope().handleFileChange(this)">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="replaceUsers" ng-model="replaceUsers">
                            <label class="form-check-label" for="replaceUsers">Replace Existing Members (this will log everyone out)</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload Members</button>
                    </form>
                </div>
            </div>
        </div>
        <h2>Add New Member</h2>
        <form ng-submit="addMember()">
            <div class="mb-3">
                <label for="newFirstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="newFirstName" ng-model="newFirstName">
            </div>
            <div class="mb-3">
                <label for="newLastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="newLastName" ng-model="newLastName">
            </div>
            <div class="mb-3">
                <label for="newUnityID" class="form-label">Unity ID</label>
                <input type="text" class="form-control" id="newUnityID" ng-model="newUnityID">
            </div>
            <div class="mb-3">
                <label for="newAffiliation" class="form-label">Affiliation</label>
                <input type="text" class="form-control" id="newAffiliation" ng-model="newAffiliation">
            </div>
            <div class="mb-3">
                <label for="newEmail" class="form-label">Email</label>
                <input type="text" class="form-control" id="newEmail" ng-model="newEmail">
            </div>
            <div class="mb-3">
                <label class="form-label">Ladder</label>
                <div>
                    <input type="radio" id="newMensLadder" name="newLadder" value="M" ng-model="newLadder">
                    <label for="newMensLadder">Mens</label>
                </div>
                <div>
                    <input type="radio" id="newWomensLadder" name="newLadder" value="W" ng-model="newLadder">
                    <label for="newWomensLadder">Womens</label>
                </div>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="newIsOfficer" ng-model="newIsOfficer">
                <label class="form-check-label" for="newIsOfficer">Is Officer</label>
            </div>
            <button type="submit" class="btn btn-primary">Add Member</button>
        </form>

        <div class="text-center">
            <a href="/admin" class="btn btn-primary">Return Home</a>
        </div>

       
    </div>
</body>

</html>
